@[TOC](针对应答协议的网络包序列特征检测)

# Abstract

> 智能家居设备通信（即使加密）往往会受到基于网络流量的被动推理攻击（当有网络包发出时，根据有限的包信息推理流量主体的行为）
>
> 本文提出的乒乓方法，就是自动从网络流量中提取包级别的特征来判断设备执行或发生的事件。
>
> 本方法能够
>
> - 从包序列的长度和方向提取之前未知的特征。
> - 根据提取的特征，预测设备特定行为的召回率高达97%。
> - 提取的特征在实际网络流量中具有唯一性
> - 实验同样适用于公开的数据库
> - 在不同的设备环境下有较好的鲁棒性

# 1.Introduction

> 智能家居一般通过WIFI路由或者手机软件/语音助手来连接到网络；

> 即使经过加密，智能家居仍然容易受到被动推理攻击。

> 现在的被动推理工具大多
>
> - 只能设备类型和是否发生了活动
> - 或者仅适用于部分设备
> - 或者需要额外的协议信息或者软件源码
>
> 此外，基于网络流量的推理攻击可能被流量整形（traffic shaping）防止。
>
> 而且，很多攻击模型都是基于：从家用路由器嗅探流量的假设，一个嗅探WIFI流量的本地攻击器往往得不到重视。

> 与云服务器的通信往往是一对长度固定的包。
>
> 根据各个设备和事件包长的不同，我们可以推断出包长中蕴含的设备信息。因此可以推断事件和设备类型。
>
> 我们通过建立包级别的特征签名（包的长度+方向）
>
> - 自动的，系统的建立包长的特征向量，而不需要关于设备行为方式的先验知识
> - 可以用来推断细粒度的信息，例如事件类别event type
> - 识别对应的一组事件（Light on/off）
> - 可统计，基于流量

## contributions

#### Packet-Level Signatures

> 签名由短的，长度指定的几个包组成。
>
> - 高达97%的召回率
> - 低FP率，1/40000000，说明这些特征是不重复的（unique）
> - 覆盖设备种类多，甚至包含了一个冰箱
> - 在多种测试环境下鲁棒性好
>   - 从测试数据集和公开可用的数据集中获取知识
>   - 多种事件触发方式：本地触发，远程手机软件触发，家庭智能系统（智能平台）触发
> - 可以从加密流量中获取数据
> - 事件检测速度快，因为特征签名短，而且只需要长度和方向信息，不涉及数据计算

#### Automated Extraction of Packet-Level Signatures

> - 没有关于设备的先验知识
> - 可以从真实的网络流量中，或者网络的trace中提取特征签名

> 特征提取方法：
>
> - 不断触发同一个事件，来获取想要的特征，同时抓取网络流量包，以此产生训练集
> - 找到对应的request/reply包对，对成对的包进行聚类，通过后处理，把这些成对的包拼成更长的序列
> - 最后，从这些序列中找到：序列中包出现的频率和事件触发频率差不多的序列作为最终的特征。
>
> 通过利用包序列特征的简单性，使特征检测工作得到简化，我们使用的是简单状态机。

# 2.Related Work

![Table1](C:\Users\8208191402\AppData\Roaming\Typora\typora-user-images\image-20221014225812534.png){table1}

## Network Signatures For IoT devices

> 目前很多工作使用网络流量分析（元数据）来表征物联网设备的类别和活动，但无法判断活动的具体类型。
>
> 目前的关于不同类型的流量特征是启发性的，但是不能自动提取。
>
> 目前有想法：通过随机流量填充（STP）来缓解基于流量的推断攻击。
>
> HomeSnitch和我们的方法，都在事件推断的包中包含了包的IP地址，端口号，DNS信息，但是利用特征的粒度不同：HomeSnitch从c/s对话的所有包中获取统计信息，我们的Ping-Pong只考虑包的方向和长度



![image-20221014231048151](C:\Users\8208191402\AppData\Roaming\Typora\typora-user-images\image-20221014231048151.png)

## Network Signatures beyond IoT devices

> 有很多利用网络流量来进行应用分类、异常检测、攻击、恶意软件植入（malware）的网络测量社区（network measurement community）
>
> 基于加密网络浏览流量的设备指纹工具，bit级别加密的聊天记录/影像数据都不够完善。
>
> 对于上述例子，这些潜在的协议都是有着充分研究的，而我们的乒乓模型可以使用在任意的，甚至不公开的应用层协议上（商用协议）

## Defenses

>在行为描述（profile）以及设备指纹方面，有很多基于混淆网络特征的防御方法。
>
>在Table1中,我们提到了两种防卫方法：
>
>- Traffic shaping，随时间不断改变原有的网络流量
>- VPN，包括数据加密（不改变我们要提取的特征）和多个网络流的多路复用，而且提供了额外防护的空间（例如package padding）

# 3.Problem Setup

## 威胁模型

>通过网络流量的元数据，泄露用户的、设备的隐私信息。

### WAN sniffer

> 监视在家用路由器和ISP代理商的网络之间的通信流量。

> 可以获得所有包的IP头部信息，但是不知晓MAC信息，因此不知道通信的是哪个设备。

> 我们假设使用NAT的家庭网络结构：所有设备的流量都复用家用路由器IP地址。

> 这类攻击的例子有智能代理（定期收集信息，提供服务的程序）和ISP

### Wi-Fi sniffer

> 监视加密的IEEE 802.11流量

> 假设这种嗅探无法获得WPA2加密技术的秘钥，那么这种模型只能获得明文传输的信息：MAC地址，包长度，时间戳信息。
>
> 因为数据包加密，Wi-Fi sniffer无法获得网络层和传输层的信息。

- 上述两种攻击模型都需要知晓要攻击的设备类型，并对其被动监视。
- 然后，在相同设备类型的一台离线设备上进行训练，提取设备特征（signature），并在未来的家庭流量中识别特征。

## 智能家居环境和实验环境设计

![image-20221014231038790](C:\Users\8208191402\AppData\Roaming\Typora\typora-user-images\image-20221014231038790.png)

>我们选取具有多种功能的智能设备（智能插座，智能摄像头），设备通过WIFI、或Ethernet（以太网）接入家庭网络。

> 图中的智能设备都是通过手机上厂商的官方软件控制的。

> 当手机与远端网络连接时，只有本地网络只监测到Device-Cloud通信——说明手机控制设备，是通过与特定厂商的云服务器通信，向设备传达远端命令来实现的。controller是操控手机的对象，可以使人或模拟软件。

> 家庭的计算型设备也会产生流量，我们称为“background traffic”，路由器通过运行一个基于Linux的、为网络设备提供的操作系统：OpenWrt/LEDE，作为我们收集网络流量的入手点。
>
> 我们使用tcpdump工具，在WAN接口层（eth0）和本地接口层（wlan1和eth1）捕获网络流量和本地流量，产生训练集（特征向量）和测试集（在包含所有智能家居流量和后台流量的网络中，探测每一个训练时得出的特征向量，对应的设备是否存在通信行为）

> 通信类型：Phone-Device，Device-Cloud，Phone-Cloud，对应图中三种沟通方式。
>
> passive inference attack，是指上述三种通信方式所产生的网络流量都会产生唯一的流量特征，可以用来发现events的存在性。

## 启发性的例子：智能插座

![image-20221015153618026](C:\Users\8208191402\AppData\Roaming\Typora\typora-user-images\image-20221015153618026.png)

> 我们对三种插座进行了人工分析：TP-Link，D-Link，SmartThings。
>
> 方式：on，工作1min，off
>
> 对产生在路由器的PCAP文件进行脚本分析和人工解析，使用Wireshark工具，对每个事件手动标注时间戳。

### Packet Pairs

> 同一类型的事件产生的包对往往相同，不同事件之间往往不同。request/reply对应两个信息流通方向。
>
> TP-Link插座：使用2个TLS协议的应用数据包进行通信，长度固定
>
> D-Link插座：本身没有数据包通信，而是控制它的手机和远端主机通信
>
> 三星插座：和TP-Link一样，一点区别是：三星的两个数据包来自两个不同IP的远端主机

### Key Insight

> 我们早就知道，每种类型的事件都要交换特定长度的包对（更长的话就是序列对）来唯一标识。
>
> 我们反过来利用长度来判断事件类型，因此称之为包级别的特征。

# 4.Design

> 我们根据对智能插座的人工研究，发现唯一的包对/序列对总会在简单事件触发后产生，因此可能用于检测时间发生。因此我们考虑：
>
> - 可否推广到更多智能设备？是否可以推广到控制设备的手机上？
> - 是否可以自动提取？
> - 是否可以准确推断出事件的类型？在整个网络流量中提取是一个挑战。

> 系统设计：training和detection，图左侧是整个网络流，右侧是TP-Link的实例

![image-20221015155224211](C:\Users\8208191402\AppData\Roaming\Typora\typora-user-images\image-20221015155224211.png)

## Training

> 对攻击者感兴趣（想要profile或者攻击）的设备提取包级别的特征，共五步

### Data Collection

> 训练集：包含事件产生的网络流量，我们用一个描述网络trace的PACP文件作为训练集。
>
> 训练集还要加上额外的text文件来描述事件发生的时间戳。

> 通过一个shell脚本实现半自动获取训练集，这个脚本通过发布我们感兴趣的的事件，所对应的用户接口来生成训练集。例如，如果要学习插座开关事件，就在屏幕上生成一个对应的按钮。缺点是设备的特征和应用特征不同，脚本需要不断改变。

>生成训练集的整个过程：
>
>- 在路由器的接口上进行tcpdump
>- 启动脚本
>- 在n个事件发布后停止tcpdump，获得原始数据集的PCAP文件和event时间戳
>
>路由器的本地接口上可以获得最为全面的trace信息，因为路由器是家用网络的制高点：同时包含了本地traffic和网络traffic，因而同时包含了设备，手机，云端之间的通讯包。

> 因为我们只需要包的长度和方向特征，网络流量的特征也可以适用于路由器的WAN端，即使是流量从本地网络的trace获得的。

### Trace Filtering

#### 前言

> TLS，全称是Transport Layer Security，是用来替代SSL的，是一种密码协议，用来提供计算机之间交互的安全通信，主要用于https
>
> ![image-20221017091832938](C:\Users\8208191402\AppData\Roaming\Typora\typora-user-images\image-20221017091832938.png)

#### 步骤

> 对raw数据集进行过滤
>
> - 舍弃与用户操作智能设备无关的包（源和目的IP既不是设备的也不是手机的）
> - 只保留每个事件时间戳之后t时间窗口内的包，其余的舍弃（这里选择t=15）

> 对所有的TCP连接进行重新聚类？？？，然后构造带有TCP连接信息的包集合P
>
> 对于TLS连接，P集合只包含未加密的TLS包记录头中，有“Application Data”标签的应用层数据包，
>
> 过滤了不可预测的，不可控制的传输层控制包（TCP ACK报文或者TLS的秘钥交换协商包）
>
> *因为控制包就和中断一样是不可预测的，和系统运行状态有关。*

> 构造包集合P‘，方法：把P中的包组装成pair。
>
> 理由：我们认为，能构成特征向量的包序列是符合request/reply交换方式的，且包对是最简单的（最小粒度的，因为长的序列可以拆成多个包对）request/reply方式体现。

### Pair Clustering

> 现在我们得到了包对集合P'，现在我们想把某类事件event的包（发生后经常出现的包对）对进行聚类。
>
> 即使是同一事件的包对，长度也可能有微小差别。
>
> 因为事先不知道包对的长度，使用无监督学习方法DBSCAN（核心点 THEN 找出所有从该点密度相连的对象，形成一个簇；对用户参数很敏感）

> DBSCAN使用的距离函数是：描述包之间的相似性；当包的方向相反，距离最远（越接近值越小）
> $$
> \sqrt{(p_1^1-p_2^1)^2+p_1^2-p_2^2)^2}
> $$
> DBSCAN的参数：&epsilon;和minPts，用来标注核心点邻居的范围和核心点的最低邻居数。
>
> 实验中分别选择&epsilon;=10和minPts=[n-0.1n]，n为某类事件出现的总次数。其中0.1n的松弛变量是因为**事件产生的网络流量偶尔会丢包**，即考虑到网络流量的不稳定。也就是我们至少需要一个事件产生所有包对的90%才能产生该事件的聚类。
>
> 因为t=15，足够等到该事件的说有包对产生到网络流量中。
>
> 我们也可以用频率f来代替n，省去了表示聚类时，时间维度的考量。

### Signature Creation/sequence merge

>- 首先舍弃所有出现频率不在[[n-0.1n]，[n+0.1n]]的聚类，这么做主要是为了过滤chatty device（周期性/不间断通信，但不产生用户操作事件的设备，类似于定时检测）。不同的n会选出不同的聚类。
>- 尽可能的把包对连接成足够长的包序列，使得特征尽可能的唯一。但是只有一个设备含有多个cluster时才能用（camera，not plug）
>- 连接原则：对Px的每一个x，在Py中总有对应的y，x和y来自同一个tcp连接。对于较长聚类多出来的包，直接舍弃。
>
>![image-20221017095505786](C:\Users\8208191402\AppData\Roaming\Typora\typora-user-images\image-20221017095505786.png)
>
>![image-20221017095659376](C:\Users\8208191402\AppData\Roaming\Typora\typora-user-images\image-20221017095659376.png)
>
>序列集合定义：
>
>- 包数量相同
>- 对应位置包方向相同
>- 对应位置相似度函数低于阈值
>
>![](C:\Users\8208191402\AppData\Roaming\Typora\typora-user-images\image-20221017100418055.png)
>
>上图根据颜色不同，可以判断Pairs1和Pairs2来自同一个TCP，Pairs3来自另一个；同时根据时间序，pairs2紧随在pairs1之后出现，没有间隔别的聚类，因此进行序列合并。
>
>最后，PINGPONG根据时间出现的时间，对序列集合进行排序，得到序列集合的列表，目的是为了让时间也成为了最终特征向量的一部分。
>
>对于无法构建这样列表的情况，最小的序列集合被舍弃。
>
>排序后的列表中，在先的序列往往是网络服务器的控制命令和设备的应答，后面的序列来自设备初始化通信，或者网络服务器通知主机自身的状态变化。
>
>![image-20221017101053156](C:\Users\8208191402\AppData\Roaming\Typora\typora-user-images\image-20221017101053156.png)

### Signature Validation

> 最后我们在训练集上使用探测算法来验证特征的有效性。
>
> ![image-20221017101453396](C:\Users\8208191402\AppData\Roaming\Typora\typora-user-images\image-20221017101453396.png)
>
> 对于每个特征序列，可能包含多个特征集合（sets），每个特征集合包含了一组非常相似的特征序列，检测时每个集合只需要取一个特征序列进行检测就行了。
>
> 如果检测算法能检测出至多n个event，而且每个检测到事件的时间戳和训练集对应事件的时间戳相同，则特征有效，写入到signature file中。
>
> 多余n个事件的特征被舍弃，因为包序列可能出现在了时间窗口t之外。

### signature file

> ![image-20221017101630981](C:\Users\8208191402\AppData\Roaming\Typora\typora-user-images\image-20221017101630981.png)

## Detection

> 特征探测的过程中，PINGPONG把网络的trace视作数据包流。
>
> *每个网络流flow的每个特征signature的每个包序列sequence维护一个状态机，这里的flow包括WAN sniffer使用的TCP连接和Wi-Fi sniffer使用的链路层帧序列流。*
>
> - 把每个单独的数据包，送入一个对应数据流的相关状态机。
>
> - 只有当前包的方向和长度，和状态机对应模板sequence的属性对应相等，状态机才进入下一个状态。
>
> - 若状态不匹配，链路层只丢弃当前不匹配的包，而传输层则会使状态机丢失当前的部分匹配结果。
> - 当状态机到达terminal state时，匹配的包序列传入下一个二极模块
> - 下一个模块暂存匹配的包序列，验证包内的时间限制（事件发生后t=15s内出现的sequence才有效），最后得出特征匹配。

# 5.Evaluation

> 泛化性研究，对于不同场景下研究结果的讨论

## automatically extract event signatures

> 为了提高模型泛化性，我们用PINGPONG对19种常用设备进行自动的训练集获取。
>
> 对每种设备独立的，没有后台流量的提取。

> 脚本对每种设备产生了100种事件（二值事件的话就只有50种，比如开关灯）
>
> （连续取值的事件，选择100个点）

### Result summary

> 结果和人工测试一样，都符合request/reply模式
>
> - Phone-Cloud通信：不属于设备范畴，有多重探测方式。
> - Device-Cloud通信：虽然经过TLSv1.2加密，仍然可以识别；
> - 只能通过WAN sniffer识别
>
> - Phone-Device通信：只能识别未加密的TCP/http协议通信的内容。这种通信只能通过WIFI sniffer识别。

### Signature Validity

> 用于拒绝在给定事件发生后的，时间窗口t外出现的signature。
>
> 这种情况一般出现在非应答协议通信方式中。

## detect events in a trace from realistic testbed

> 只包含13种设备，便于实时添加设备种类而不需要改变模型的设定；包含后台流量设备。
>
> 添加剩余六种设备的时候，十三种设备作为噪声。

### Result Summary

> 同时使用WAN和Wi-Fi sniffer进行探测，FPR约0.25%

## negative control experiments

> 特征在复杂环境中仍要具有识别度，就要保证特征向量的唯一性。
>
> 我们使用三个数据集进行特征探测，1,2号数据集用众多相似智能设备产生的traffic，3号用通用计算设备产生的traffic。

### 以False Positive为标准

> 对数据集1,3进行全设备（数据集内的）的特征探测。
>
> 对数据集2只对数据集中不包含的，我们的设备进行特征探测，减少True Positive，通过FPR判断模型效率。
>
> 对有Phone-Cloud和Device-Cloud特征的设备使用WAN sniffer，对所有设备使用Wi-Fi sniffer。

> 结论：
>
> - FPR极低，1/40million
>
> - 越是短的包序列越容易产生FPR（尤其是包对），即FPR取决于signature长度而不是设备类型

## trigger method

> 之前的模型是使用家庭环境内部的一个手机触发的，现在我们用远程手机或者智能家居平台来操控。
>
> 结果表明三者提取的特征值大致类似。

## uniqueness of signatures from the same vender

> common device，在公开数据集合我们的数据集都有的设备。
>
> 我们对两个数据集分别提取特征，相比于在我们的模型上训练，在别的模型上预测能提供更多的信息。
>
> 设备特征有的完全相同，有的类似：
>
> - Identical signature，对相同的特征使用第四部分的Detection的状态机来实现，召回率97%
> - Similar signature，两个数据集采集的数据略有不同。但二者提取的特征都是确定的值，不是一个区间。根据差值最大的TP-Link的额外研究，我们发现配置参数的变化（eg，用户资格证书长度的不同）是导致包长度不同的原因（虽然每个用户的整数长度固定）
>   - 因此，使用relaxed matching来扩大匹配策略的范围
>   - relax matching中，delta的取值是所有包长度变化中最大的差值，这里取21B时可以检测所有。
>   - relaxed matching也可能会导致误判。

### signature evolution

> 有些特征随着设备版本更新会变化，我们没有自动更新方法，在条件允许情况下可以再次训练模型。

## selection and sensitivity of parameters

> 对于DBSCAN，选择默认&epsilon;=10和minPts=45。

> 时间窗口选择15s，确保event能在窗口内完成，同时区分误正率和正确率。

# 6.防御措施

> 一般是通过混淆网络流量的方式来防御被动推理攻击，使网络流量元数据不可见。
>
> - Packet padding（most natural）
> - Traffic shaping，可以延缓一个时间发送数据包。主要防御根据包到达时间和随时间流量变化的攻击。
> - Traffic injection，添加冗余的包到流量中，这些包有真实event的特征，用于混淆和隐藏真实的事件。

## Packet padding

> 每个包添加冗余字节，可以填充到固定长度（MTU），或者随机长度。
>
> 主要防御根据包长和流量大小推断的攻击。

> 目前用作抵御网络指纹攻击的方法。

> 这里是把包填充成一个固定长度（MTU），形成特征：<direction,packet length>，可以有效防御本文的攻击。
>
> padding可以显著减小Jaccard系数（交集/并集）为基础的分类器的准确度和朴素贝叶斯分类器的准确度；但是对更复杂的分类器效果不佳（例如，支持向量机会对更粗粒度的信息进行分析，例如总网络流量）

### Possible Implements

#### VPN-Based at network

>把从家用设备和手机产生的网络流量经过VPN网络进行路由。在数据离开VPN管道时进行填充，在数据进入时删除填充的字符。
>
>设备和手机可以直接接入VPN，但是对受限设备可能无法实现。这种方式可以防御两种形式的sniffer；
>
>也可以先经过路由器，路由器接入VPN，这样可以对现有设备直接使用，而不需要修改软件代码。这种方式只能防御WAN sniffer。

#### TLS-Based at Application Layer

>- 保留了所有连接的padding，可防御两种sniffer
>- 终端用户不需要任何配置路由和VPN的工作
>- 可以纯软件实现
>
>HTTPOS即一个例子，随机化http请求的长度；这种方法对应用层开发增加了额外的工作。
>
>折中：在应用层和网络之间进行padding。

### 其他的侧信道攻击

> Packet padding之外还有其他的侧信道攻击方式，包括细粒度的：包的时间戳，方向和粗粒度的：网络流量，包总数，突发性等等。
>
> 时间信息是和通信位置相关的，受设备和云端的传播时延、排队时延、发送时延影响的；要通过时间信息攻击，必须获得非常接近设备的接入点，难以实现，因此时间信息是安全的。

## Efficacy of packet padding

> 设计一个对TP-Link插座进行packet padding的效率

### Set up

- 只考虑包的方向和顺序，不考虑长度
- 主要是用WAN sniffer，因为WAN sniffer是最强大的对抗攻击之一，他可以把流量划分成独立的TCP连接，消除通过流复用产生的干扰/混淆。
- 2-packet signature，2events（on/off）
- 攻击方使用训练时获取的时间信息，只考虑符合在指定时间区间内的特征。
- 因为设备使用了TLS加密，但没有对SNI加密。因此，攻击者只选取trace中，与服务器相关的主机的TLS Application data packets。（没有VPN的情况）

### VPN-Based padding

> 我们假设所有的包都复用同一个链接，只在这一个频道上使用特征检测。
>
> 1933FP/193338，可见这种方案对于短特征向量的设备效果很好。（FP大多是短序列造成的）

### TLS-Based padding

> 我们对每一个使用了TLS加密的独立连接上，使用TLS应用层数据报进行特征检测。
>
> 0FP，因为只包含一种包序列，不存在误判。共100个events。

## Hybrid

> 讨论所有TP-link流量复用同一个connection对FP的影响。（TP-Link会和多个TP host通信，所以才有复用的说法）
>
> 这类似于VPN，但是是在使用应用层协议实体之间的，可以在用户空间实现的。

### Set up

> 只保留在TP-Link上的Ipv4单播通信，丢弃所有不是TLS Application Data的包。
>
> detect时视作是来自同一个连接的包。

### Result

> 比使用单独的TLS连接效果好了10倍左右（FP少了10倍），但还是可能被推断出event的存在。

## Summary

> 推荐使用VPN-Based padding，因为它的额外混淆功能：互连网终端接入点的加密，以及把物联网设备流量和其他流量复用到一起。

# 7.Conclusion & Discussion

## Summary

- 使用简单包级别的特征
- 自动从训练集提取特征
- 训练的特征适用于多种不同设备和攻击工具
- 可以运用到实施被动推理攻击，异常（anomaly）探测等等

## Limitation & Future works

- 必须要获取设备，才能训练设备的特征。
  - 攻击者往往知晓自己要攻击或区分的设备对象集合，因此是可以实现的。
  - 我们希望能通过松弛匹配时对已知和位置signature的匹配，能够从一个设备的signature推断出similar设备的signature。
- 软件/设备更新版本可能会有协议变化，signature长度会改变。
- 只限于符合应答协议的TCP连接类型

## Conclusion

> 好用，有待提高。
